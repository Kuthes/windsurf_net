name: Build and Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        # Add DOCKERHUB_TOKEN to secrets
        uses: docker/login-action@v3
        with:
          username: saurabh7876
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Laravel image
        uses: docker/build-push-action@v5
        with:
          context: ./src
          file: ./src/Dockerfile
          push: true
          tags: saurabh7876/sentinel-laravel:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: 114.143.224.99
          username: saurabh
          password: ${{ secrets.SSH_PASSWORD }}
          port: 51826
          # Pass secrets as environment variables to the script
          envs: DOCKERHUB_TOKEN,SSH_PASSWORD
          script: |
              # Export env vars from the passed arguments
              export DOCKERHUB_TOKEN=$DOCKERHUB_TOKEN
              export SSH_PASSWORD=$SSH_PASSWORD
              
              if [ -z "$SSH_PASSWORD" ]; then
                echo "Error: SSH_PASSWORD is empty. Check GitHub Secrets."
                exit 1
              fi
              
              # Create directory if it doesn't exist
              mkdir -p ~/windsurf_net
              cd ~/windsurf_net
              
              # Initialize git if not present
              if [ ! -d ".git" ]; then
                echo "Initializing git..."
                git init
                git remote add origin https://github.com/Kuthes/windsurf_net.git
                git fetch origin
                git checkout -f main
                git branch -u origin/main main
              else
                echo "Pulling latest..."
                git pull origin main
              fi
              
              # Create temporary credential files for robust input handling
              echo "$DOCKERHUB_TOKEN" > docker_token.txt
              echo "$SSH_PASSWORD" > sudo_pass.txt
              chmod 600 docker_token.txt sudo_pass.txt
              
              # Login to Docker Hub
              # sudo -S reads password from stdin (redirected from sudo_pass.txt)
              # bash -c runs command that reads token from file
              sudo -S bash -c "cat docker_token.txt | docker login -u saurabh7876 --password-stdin" < sudo_pass.txt

              # Pull the latest images
              sudo -S docker compose pull laravel < sudo_pass.txt
              
              # Restart services
              sudo -S docker compose up -d < sudo_pass.txt
              
              # Cleanup credentials immediately
              rm docker_token.txt sudo_pass.txt
