name: Build and Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        # Add DOCKERHUB_TOKEN to secrets
        uses: docker/login-action@v3
        with:
          username: saurabh7876
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Laravel image
        uses: docker/build-push-action@v5
        with:
          context: ./src
          file: ./src/Dockerfile
          push: true
          tags: saurabh7876/sentinel-laravel:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: 114.143.224.99
          username: saurabh
          password: ${{ secrets.SSH_PASSWORD }}
          port: 51826
          script: |
              # Create directory if it doesn't exist (first run precaution)
              mkdir -p ~/windsurf_net
              cd ~/windsurf_net
              
              # Initialize git if not present
              if [ ! -d ".git" ]; then
                echo "Initializing git..."
                git init
                git remote add origin https://github.com/Kuthes/windsurf_net.git
                git fetch origin
                # Force checkout to ensure repo state, but won't touch untracked files like .env
                git checkout -f main
                git branch -u origin/main main
              else
                echo "Pulling latest..."
                git pull origin main
              fi
              
              # Pull the latest images defined in docker-compose
              sudo docker compose pull laravel
              
              # Restart services with new configuration/image
              sudo docker compose up -d
